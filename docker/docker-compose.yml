services:
  ai:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-cli
    environment:
      USER_NAME: ${USER_NAME}
      # Vibe Kanban configuration
      VIBE_KANBAN_PORT: ${VIBE_KANBAN_PORT:-3000}
      # Force CLI tools reinstallation (set by setup wizard when Force Rebuild is checked)
      FORCE_CLI_REINSTALL: ${FORCE_CLI_REINSTALL:-}
      # Mobile access configuration (SSH + Mosh + tmux)
      # Set ENABLE_MOBILE_ACCESS=1 to enable remote access from mobile devices
      ENABLE_MOBILE_ACCESS: ${ENABLE_MOBILE_ACCESS:-0}
      SSH_PORT: ${SSH_PORT:-2222}
      MOSH_PORT_START: ${MOSH_PORT_START:-60001}
      MOSH_PORT_END: ${MOSH_PORT_END:-60005}
    secrets:
      - user_password
    ports:
      # Vibe Kanban web UI - accessible from Windows browser at http://localhost:3000
      - "${VIBE_KANBAN_PORT:-3000}:${VIBE_KANBAN_PORT:-3000}"
      # SSH for mobile access (only exposed when ENABLE_MOBILE_ACCESS=1)
      - "${SSH_PORT:-2222}:${SSH_PORT:-2222}"
      # Mosh UDP ports for persistent mobile connections (5 concurrent connections)
      - "${MOSH_PORT_START:-60001}-${MOSH_PORT_END:-60005}:${MOSH_PORT_START:-60001}-${MOSH_PORT_END:-60005}/udp"
    volumes:
      - ${WORKSPACE_PATH}:/workspace
      - claude-config:/home/${USER_NAME}/.claude
      # Vibe Kanban data persistence
      - vibe-kanban-data:/home/${USER_NAME}/.vibe-kanban
      # SSH keys persistence for mobile access
      - ssh-keys:/home/${USER_NAME}/.ssh
    tty: true
    stdin_open: true

# Docker secrets for secure password handling
# Password is stored in tmpfs (memory-only) at /run/secrets/user_password
secrets:
  user_password:
    file: .secrets/password.txt

volumes:
  claude-config:
    driver: local
  vibe-kanban-data:
    driver: local
  ssh-keys:
    driver: local
